{
  "version": 3,
  "sources": ["../../src/scheduler/OneTimeTriggerScheduler.ts"],
  "sourcesContent": ["import type { Job, JobCallback } from \"node-schedule\";\nimport type { LoggingService } from \"../services/LoggingService\";\nimport { OneTimeTrigger } from \"../triggers/OneTimeTrigger\";\nimport { TriggerScheduler } from \"./TriggerScheduler\";\n\n/**\n * OneTimeTriggerScheduler\n */\nexport class OneTimeTriggerScheduler extends TriggerScheduler {\n    private registered: [OneTimeTrigger, Job][] = [];\n    private triggerTimeout: ioBroker.Timeout | undefined;\n\n    /**\n     * @param scheduleJob Schedule\n     * @param cancelJob Schedule\n     * @param logger Log service\n     * @param adapter ioBroker\n     */\n    constructor(\n        private scheduleJob: (date: Date, callback: JobCallback) => Job,\n        private cancelJob: (job: Job) => boolean,\n        private logger: LoggingService,\n        private adapter: ioBroker.Adapter,\n    ) {\n        super();\n        this.adapter = adapter;\n        this.triggerTimeout = undefined;\n    }\n\n    /**\n     * forType\n     */\n    public forType(): string {\n        return OneTimeTrigger.prototype.constructor.name;\n    }\n\n    /**\n     * @param trigger OneTimeTrigger\n     */\n    public register(trigger: OneTimeTrigger): void {\n        this.logger.logDebug(`Register OneTimeTriggerScheduler trigger ${trigger}`);\n        if (this.getAssociatedJob(trigger)) {\n            this.logger.logWarn(`OneTimeTrigger ${trigger} is already registered.`);\n        } else {\n            if (trigger.getDate() < new Date()) {\n                this.logger.logDebug(`Date is in past, deleting OneTimeTriggerScheduler ${trigger}`);\n                this.triggerTimeout = this.adapter.setTimeout(() => {\n                    trigger.destroy();\n                    this.triggerTimeout = undefined;\n                }, 2000);\n            } else {\n                const newJob = this.scheduleJob(trigger.getDate(), () => {\n                    this.logger.logDebug(`Executing trigger ${trigger}`);\n                    trigger.getAction().execute(trigger);\n                });\n                this.registered.push([trigger, newJob]);\n            }\n        }\n    }\n\n    /**\n     * @param trigger OneTimeTrigger\n     */\n    public unregister(trigger: OneTimeTrigger): void {\n        this.logger.logDebug(`Unregister OneTimeTriggerScheduler trigger ${trigger}`);\n        const job = this.getAssociatedJob(trigger);\n        if (job) {\n            this.logger.logDebug(`Unregister OneTimeTriggerScheduler trigger ${trigger}`);\n            this.cancelJob(job);\n            this.removeTrigger(trigger);\n        } else {\n            this.logger.logDebug(`Error Unregister OneTimeTriggerScheduler trigger ${trigger}`);\n        }\n    }\n\n    /**\n     * loadregister\n     */\n    public loadregister(): void {\n        for (const r of this.registered) {\n            this.logger.logDebug(`Check OneTimeTriggerScheduler ${r[0]}`);\n        }\n    }\n\n    /**\n     * destroy\n     */\n    public destroy(): void {\n        this.triggerTimeout && this.adapter.clearTimeout(this.triggerTimeout);\n        this.registered.forEach(r => this.unregister(r[0]));\n    }\n\n    private getAssociatedJob(trigger: OneTimeTrigger): Job | null {\n        const entry = this.registered.find(r => r[0] === trigger);\n        if (entry) {\n            return entry[1];\n        }\n        this.loadregister();\n        return null;\n    }\n\n    private removeTrigger(trigger: OneTimeTrigger): void {\n        this.registered = this.registered.filter(r => r[0] !== trigger);\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,4BAA+B;AAC/B,8BAAiC;AAK1B,MAAM,gCAAgC,yCAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAU1D,YACY,aACA,WACA,QACA,SACV;AACE,UAAM;AALE;AACA;AACA;AACA;AAGR,SAAK,UAAU;AACf,SAAK,iBAAiB;AAAA,EAC1B;AAAA,EAlBQ,aAAsC,CAAC;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAsBD,UAAkB;AACrB,WAAO,qCAAe,UAAU,YAAY;AAAA,EAChD;AAAA;AAAA;AAAA;AAAA,EAKO,SAAS,SAA+B;AAC3C,SAAK,OAAO,SAAS,4CAA4C,OAAO,EAAE;AAC1E,QAAI,KAAK,iBAAiB,OAAO,GAAG;AAChC,WAAK,OAAO,QAAQ,kBAAkB,OAAO,yBAAyB;AAAA,IAC1E,OAAO;AACH,UAAI,QAAQ,QAAQ,IAAI,oBAAI,KAAK,GAAG;AAChC,aAAK,OAAO,SAAS,qDAAqD,OAAO,EAAE;AACnF,aAAK,iBAAiB,KAAK,QAAQ,WAAW,MAAM;AAChD,kBAAQ,QAAQ;AAChB,eAAK,iBAAiB;AAAA,QAC1B,GAAG,GAAI;AAAA,MACX,OAAO;AACH,cAAM,SAAS,KAAK,YAAY,QAAQ,QAAQ,GAAG,MAAM;AACrD,eAAK,OAAO,SAAS,qBAAqB,OAAO,EAAE;AACnD,kBAAQ,UAAU,EAAE,QAAQ,OAAO;AAAA,QACvC,CAAC;AACD,aAAK,WAAW,KAAK,CAAC,SAAS,MAAM,CAAC;AAAA,MAC1C;AAAA,IACJ;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKO,WAAW,SAA+B;AAC7C,SAAK,OAAO,SAAS,8CAA8C,OAAO,EAAE;AAC5E,UAAM,MAAM,KAAK,iBAAiB,OAAO;AACzC,QAAI,KAAK;AACL,WAAK,OAAO,SAAS,8CAA8C,OAAO,EAAE;AAC5E,WAAK,UAAU,GAAG;AAClB,WAAK,cAAc,OAAO;AAAA,IAC9B,OAAO;AACH,WAAK,OAAO,SAAS,oDAAoD,OAAO,EAAE;AAAA,IACtF;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKO,eAAqB;AACxB,eAAW,KAAK,KAAK,YAAY;AAC7B,WAAK,OAAO,SAAS,iCAAiC,EAAE,CAAC,CAAC,EAAE;AAAA,IAChE;AAAA,EACJ;AAAA;AAAA;AAAA;AAAA,EAKO,UAAgB;AACnB,SAAK,kBAAkB,KAAK,QAAQ,aAAa,KAAK,cAAc;AACpE,SAAK,WAAW,QAAQ,OAAK,KAAK,WAAW,EAAE,CAAC,CAAC,CAAC;AAAA,EACtD;AAAA,EAEQ,iBAAiB,SAAqC;AAC1D,UAAM,QAAQ,KAAK,WAAW,KAAK,OAAK,EAAE,CAAC,MAAM,OAAO;AACxD,QAAI,OAAO;AACP,aAAO,MAAM,CAAC;AAAA,IAClB;AACA,SAAK,aAAa;AAClB,WAAO;AAAA,EACX;AAAA,EAEQ,cAAc,SAA+B;AACjD,SAAK,aAAa,KAAK,WAAW,OAAO,OAAK,EAAE,CAAC,MAAM,OAAO;AAAA,EAClE;AACJ;",
  "names": []
}
