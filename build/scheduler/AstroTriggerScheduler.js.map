{
  "version": 3,
  "sources": ["../../src/scheduler/AstroTriggerScheduler.ts"],
  "sourcesContent": ["import { GetTimesResult } from \"suncalc\";\nimport { Coordinate } from \"../Coordinate\";\nimport { IoBrokerStateService } from \"../services/IoBrokerStateService\";\nimport { LoggingService } from \"../services/LoggingService\";\nimport { AstroTrigger } from \"../triggers/AstroTrigger\";\nimport { TimeTrigger } from \"../triggers/TimeTrigger\";\nimport { TimeTriggerBuilder } from \"../triggers/TimeTriggerBuilder\";\nimport { AllWeekdays } from \"../triggers/Weekday\";\nimport { TimeTriggerScheduler } from \"./TimeTriggerScheduler\";\nimport { TriggerScheduler } from \"./TriggerScheduler\";\n\nexport class AstroTriggerScheduler extends TriggerScheduler {\n    private registered: AstroTrigger[] = [];\n    private scheduled: [string, TimeTrigger][] = [];\n    private readonly rescheduleTrigger = new TimeTriggerBuilder()\n        .setId(`AstroTriggerScheduler-Rescheduler`)\n        .setWeekdays(AllWeekdays)\n        .setHour(2)\n        .setMinute(0)\n        .setTodayTrigger({})\n        .setAction({\n            execute: () => {\n                this.logger.logDebug(`Rescheduling astro triggers`);\n                this.scheduled.forEach((s) => this.timeTriggerScheduler.unregister(s[1]));\n                this.registered.forEach((r) => this.tryScheduleTriggerToday(r));\n            },\n        })\n        .build();\n\n    constructor(\n        private readonly timeTriggerScheduler: TimeTriggerScheduler,\n        private readonly getTimes: (date: Date, latitude: number, longitude: number) => GetTimesResult,\n        private readonly coordinate: Coordinate,\n        private readonly logger: LoggingService,\n        private readonly stateService: IoBrokerStateService,\n        private readonly namespace: string,\n    ) {\n        super();\n        this.timeTriggerScheduler.register(this.rescheduleTrigger);\n    }\n\n    public register(trigger: AstroTrigger): void {\n        this.logger.logDebug(`Register astro trigger ${trigger}`);\n        if (this.isRegistered(trigger)) {\n            throw new Error(`Trigger ${trigger} is already registered.`);\n        }\n        this.registered.push(trigger);\n        this.tryScheduleTriggerToday(trigger);\n    }\n\n    public unregister(trigger: AstroTrigger): void {\n        this.logger.logDebug(`Unregister astro trigger ${trigger}`);\n        if (this.isRegistered(trigger)) {\n            this.registered = this.registered.filter((t) => t.getId() !== trigger.getId());\n            if (this.isScheduledToday(trigger)) {\n                this.scheduled = this.scheduled.filter((s) => {\n                    if (s[0] === trigger.getId()) {\n                        this.timeTriggerScheduler.unregister(s[1]);\n                        return false;\n                    }\n                    return true;\n                });\n            }\n        } else {\n            throw new Error(`Trigger ${trigger} is not registered.`);\n        }\n    }\n\n    public destroy(): void {\n        this.timeTriggerScheduler.destroy();\n        this.registered = [];\n        this.scheduled = [];\n    }\n\n    public forType(): string {\n        return AstroTrigger.prototype.constructor.name;\n    }\n\n    private tryScheduleTriggerToday(trigger: AstroTrigger): void {\n        const now = new Date();\n        const next = this.nextDate(trigger);\n        this.logger.logDebug(`Time ${next} - Date ${now}`);\n        if (next >= now && trigger.getWeekdays().includes(now.getDay())) {\n            const timeTrigger = new TimeTriggerBuilder()\n                .setId(`TimeTriggerForAstroTrigger:${trigger.getId()}`)\n                .setHour(next.getHours())\n                .setMinute(next.getMinutes())\n                .setTodayTrigger({\n                    hour: next.getHours(),\n                    minute: next.getMinutes(),\n                    weekday: next.getDay(),\n                    date: next,\n                })\n                .setWeekdays([next.getDay()])\n                .setAction({\n                    execute: () => {\n                        this.logger.logDebug(`Executing trigger ${trigger}`);\n                        trigger.getAction().execute(trigger.getData() as any);\n                    },\n                })\n                .build();\n            this.logger.logDebug(`Scheduled with ${timeTrigger}`);\n            this.setNewTime(timeTrigger);\n            this.timeTriggerScheduler.register(timeTrigger);\n            this.scheduled.push([trigger.getId(), timeTrigger]);\n        } else {\n            this.logger.logDebug(`Didn't schedule`);\n        }\n    }\n\n    private isRegistered(trigger: AstroTrigger): boolean {\n        return this.registered.find((r) => r.getId() === trigger.getId()) != undefined;\n    }\n\n    private isScheduledToday(trigger: AstroTrigger): boolean {\n        return this.scheduled.find((s) => s[0] === trigger.getId()) != undefined;\n    }\n\n    private nextDate(trigger: AstroTrigger): Date {\n        const next = this.getTimes(new Date(), this.coordinate.getLatitude(), this.coordinate.getLongitude())[\n            trigger.getAstroTime()\n        ];\n        next.setMinutes(next.getMinutes() + trigger.getShiftInMinutes());\n        return next;\n    }\n\n    private async setNewTime(trigger: TimeTrigger): Promise<void> {\n        const val = await this.stateService.getState(\n            `${this.namespace}.onoff.${trigger.getObjectId().toString()}.data`,\n        );\n        if (val && typeof val === \"string\") {\n            const actual_trigger = JSON.parse(val);\n            const triggerId: string = trigger.getId().split(\":\")[1];\n            if (actual_trigger && actual_trigger.triggers && triggerId != null) {\n                const old_trigger = actual_trigger.triggers.find((id: any) => id.id == triggerId);\n                if (trigger) {\n                    old_trigger.todayTrigger = trigger.getTodayTrigger();\n                    await this.stateService.setState(\n                        `${this.namespace}.onoff.${trigger.getObjectId().toString()}.data`,\n                        JSON.stringify(actual_trigger),\n                        true,\n                    );\n                }\n            }\n        }\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
