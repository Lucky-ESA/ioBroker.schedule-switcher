{
  "version": 3,
  "sources": ["../../src/scheduler/AstroTriggerScheduler.ts"],
  "sourcesContent": ["import type { GetTimesResult } from \"suncalc\";\nimport type { Coordinate } from \"../Coordinate\";\nimport type { IoBrokerStateService } from \"../services/IoBrokerStateService\";\nimport type { LoggingService } from \"../services/LoggingService\";\nimport { AstroTrigger } from \"../triggers/AstroTrigger\";\nimport type { TimeTrigger } from \"../triggers/TimeTrigger\";\nimport { TimeTriggerBuilder } from \"../triggers/TimeTriggerBuilder\";\nimport { AllWeekdays } from \"../triggers/Weekday\";\nimport type { TimeTriggerScheduler } from \"./TimeTriggerScheduler\";\nimport { TriggerScheduler } from \"./TriggerScheduler\";\n\n/**\n * AstroTriggerScheduler\n */\nexport class AstroTriggerScheduler extends TriggerScheduler {\n    private registered: AstroTrigger[] = [];\n    private scheduled: [string, TimeTrigger][] = [];\n    private readonly rescheduleTrigger = new TimeTriggerBuilder()\n        .setId(`AstroTriggerScheduler-Rescheduler`)\n        .setWeekdays(AllWeekdays)\n        .setHour(2)\n        .setMinute(0)\n        .setTodayTrigger({})\n        .setAction({\n            execute: () => {\n                this.logger.logDebug(`Rescheduling astro triggers`);\n                for (const s of this.scheduled) {\n                    this.timeTriggerScheduler.unregister(s[1]);\n                }\n                for (const r of this.registered) {\n                    this.tryScheduleTriggerToday(r);\n                }\n                this.loadregister();\n                this.timeTriggerScheduler.loadregister();\n            },\n        })\n        .build();\n\n    /**\n     * @param timeTriggerScheduler Scheduler\n     * @param getTimes GetTimesResult\n     * @param coordinate Coodinate\n     * @param logger Log service\n     * @param stateService setState\n     */\n    constructor(\n        private readonly timeTriggerScheduler: TimeTriggerScheduler,\n        private readonly getTimes: (date: Date, latitude: number, longitude: number) => GetTimesResult,\n        private readonly coordinate: Coordinate,\n        private readonly logger: LoggingService,\n        private readonly stateService: IoBrokerStateService,\n    ) {\n        super();\n        this.timeTriggerScheduler.register(this.rescheduleTrigger);\n    }\n\n    /**\n     * @param trigger Trigger\n     */\n    public register(trigger: AstroTrigger): void {\n        this.logger.logDebug(`Register astro trigger ${trigger}`);\n        if (this.isRegistered(trigger)) {\n            this.logger.logWarn(`AstroTrigger ${trigger} is already registered.`);\n            this.loadregister();\n        } else {\n            this.registered.push(trigger);\n            this.tryScheduleTriggerToday(trigger);\n        }\n    }\n\n    /**\n     * @param trigger Trigger\n     */\n    public unregister(trigger: AstroTrigger): void {\n        this.logger.logDebug(`Unregister astro trigger ${trigger}`);\n        if (this.isRegistered(trigger)) {\n            this.registered = this.registered.filter(t => t.getId() !== trigger.getId());\n            if (this.isScheduledToday(trigger)) {\n                this.scheduled = this.scheduled.filter(s => {\n                    if (s[0] === trigger.getId()) {\n                        this.timeTriggerScheduler.unregister(s[1]);\n                        return false;\n                    }\n                    return true;\n                });\n            } else {\n                this.logger.logWarn(`AstroTrigger ${trigger} is not today.`);\n                this.loadregister();\n            }\n        } else {\n            this.logger.logWarn(`AstroTrigger ${trigger} is not registered.`);\n            this.loadregister();\n        }\n    }\n\n    /**\n     * loadregister\n     */\n    public loadregister(): void {\n        for (const r of this.registered) {\n            this.logger.logDebug(`Check AstroTriggerRegistered ${r}`);\n        }\n        for (const s of this.scheduled) {\n            this.logger.logDebug(`Check AstroTriggerScheduler ${s[1]}`);\n        }\n    }\n\n    /**\n     * destroy\n     */\n    public destroy(): void {\n        this.timeTriggerScheduler.destroy();\n        this.registered = [];\n        this.scheduled = [];\n    }\n\n    /**\n     * forType\n     */\n    public forType(): string {\n        return AstroTrigger.prototype.constructor.name;\n    }\n\n    private tryScheduleTriggerToday(trigger: AstroTrigger): void {\n        const now = new Date();\n        const next = this.nextDate(trigger);\n        this.logger.logDebug(`Time ${next.toString()} - Date ${now.toString()}`);\n        if (next >= now && trigger.getWeekdays().includes(now.getDay())) {\n            const entry = this.registered.find(t => t.getId() === trigger.getId());\n            const objectId = entry && typeof entry.getObjectId() === \"number\" ? entry.getObjectId() : 0;\n            this.removeScheduled(trigger);\n            const timeTrigger = new TimeTriggerBuilder()\n                .setId(`TimeTriggerForAstroTrigger:${trigger.getId()}`)\n                .setHour(next.getHours())\n                .setMinute(next.getMinutes())\n                .setObjectId(objectId)\n                .setTodayTrigger({\n                    hour: next.getHours(),\n                    minute: next.getMinutes(),\n                    weekday: next.getDay(),\n                    date: next,\n                })\n                .setWeekdays([next.getDay()])\n                .setAction({\n                    execute: () => {\n                        this.logger.logDebug(`Executing astrotrigger ${trigger}`);\n                        trigger.getAction().execute(trigger.getData());\n                    },\n                })\n                .build();\n            this.logger.logDebug(`Scheduled astro with ${timeTrigger}`);\n            this.timeTriggerScheduler.register(timeTrigger);\n            this.scheduled.push([trigger.getId(), timeTrigger]);\n        } else {\n            this.logger.logDebug(`Didn't schedule ${trigger}`);\n        }\n    }\n\n    private isRegistered(trigger: AstroTrigger): boolean {\n        return this.registered.find(r => r.getId() === trigger.getId()) != undefined;\n    }\n\n    private isScheduledToday(trigger: AstroTrigger): boolean {\n        return this.scheduled.find(s => s[0] === trigger.getId()) != undefined;\n    }\n\n    private removeScheduled(trigger: AstroTrigger): void {\n        this.logger.logDebug(`Scheduled remove ${trigger}`);\n        this.scheduled = this.scheduled.filter(s => s[0] !== trigger.getId());\n    }\n\n    private nextDate(trigger: AstroTrigger): Date {\n        const next = this.getTimes(new Date(), this.coordinate.getLatitude(), this.coordinate.getLongitude())[\n            trigger.getAstroTime()\n        ];\n        next.setMinutes(next.getMinutes() + trigger.getShiftInMinutes());\n        return next;\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
